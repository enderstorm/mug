#!/bin/bash

cwd=$(pwd)

repo="seges/"

function check_cwd_project
{
	if [ -f $cwd/package.json ]; then
		prj="frontend-javascript"
	elif [ -f $cwd/build.sbt ]; then
		prj="backend-scala"
	elif [ -f $cwd/pom.xml ]; then
		prj="backend-java"
	fi
}

if [ $# -eq 1 ]; then
	if [ "$1" == "--local" ]; then
		repo=""
		check_cwd_project
	else
		prj="$1"
		project_name=$(basename $cwd)
	fi
else
	check_cwd_project
fi

if [ "$prj" == "" ]; then
	echo "I don't think $cwd contains any supported project"
	exit 42
fi

function getJsonVal() { 
   if [ \( $# -ne 1 \) -o \( -t 0 \) ]; then
       echo "Usage: getJsonVal 'key' < /tmp/file";
       echo "   -- or -- ";
       echo " cat /tmp/input | getJsonVal 'key'";
       return;
   fi;
   python -c "import json,sys;sys.stdout.write(json.dumps(json.load(sys.stdin)$1))";
}

function getXmlVal() {
	python -c "import xml.etree.ElementTree as ET;tree = ET.parse('$cwd/pom.xml');root = tree.getroot();print tree.find('./{http://maven.apache.org/POM/4.0.0}artifactId').text"
}

if [ "$prj" == "frontend-javascript" ]; then
	if [ "$project_name" == "" ]; then
		project_name=$(cat $cwd/package.json | getJsonVal "['name']" | sed -e 's/^"//'  -e 's/"$//')
	fi
	ports="-p 3000:3000"
elif [ "$prj" == "backend-scala" ]; then
	if [ "$project_name" == "" ]; then
		project_name=$(cat build.sbt | grep "name" | sed 's/.*"\([^"]*\)"/\1/')
	fi
	volumes="-v $HOME/.ivy2-mug:/home/developer/.ivy2"
elif [ "$prj" == "backend-java" ]; then
	if [ "$project_name" == "" ]; then
		project_name=$(cat $cwd/pom.xml | getXmlVal )
	fi
	volumes="-v $HOME/.m2-mug:/home/developer/.m2"

fi

volumes="-v $cwd:/home/developer/$project_name $volumes"
echo "Running $project_name in $cwd as ${repo}mug-$prj [ volumes = $volumes , ports = $ports]"

docker run $ports $volumes --rm -ti ${repo}mug-$prj

